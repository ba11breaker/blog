<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>koa4 | Alex Zhao’s Space</title>
    <meta name="generator" content="VuePress 1.5.2">
    
    <meta name="description" content="Focus on Web Development, From Front End to Computer System">
    <link rel="preload" href="/blog/assets/css/0.styles.adc68ea4.css" as="style"><link rel="preload" href="/blog/assets/js/app.cdb96da4.js" as="script"><link rel="preload" href="/blog/assets/js/2.f437480e.js" as="script"><link rel="preload" href="/blog/assets/js/13.41210d01.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.971ef32e.js"><link rel="prefetch" href="/blog/assets/js/11.420ef912.js"><link rel="prefetch" href="/blog/assets/js/12.b0892eb5.js"><link rel="prefetch" href="/blog/assets/js/14.c098bad3.js"><link rel="prefetch" href="/blog/assets/js/15.eb936fac.js"><link rel="prefetch" href="/blog/assets/js/16.d891299b.js"><link rel="prefetch" href="/blog/assets/js/17.4298436d.js"><link rel="prefetch" href="/blog/assets/js/3.dbc4f5df.js"><link rel="prefetch" href="/blog/assets/js/4.8c5061f6.js"><link rel="prefetch" href="/blog/assets/js/5.c38ecffa.js"><link rel="prefetch" href="/blog/assets/js/6.5c11dd68.js"><link rel="prefetch" href="/blog/assets/js/7.faedfaac.js"><link rel="prefetch" href="/blog/assets/js/8.dcf8f93d.js"><link rel="prefetch" href="/blog/assets/js/9.39759eeb.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.adc68ea4.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">Alex Zhao’s Space</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Back End" class="dropdown-title"><span class="title">Back End</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/node/" class="nav-link router-link-active">
  node
</a></li><li class="dropdown-item"><!----> <a href="/blog/dotnet/" class="nav-link">
  dotnet
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Computer Science" class="dropdown-title"><span class="title">Computer Science</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/operating system/" class="nav-link">
  OS
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Front End" class="dropdown-title"><span class="title">Front End</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/angular/" class="nav-link">
  Angular
</a></li><li class="dropdown-item"><!----> <a href="/blog/react/" class="nav-link">
  React
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/ba11breaker" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Back End" class="dropdown-title"><span class="title">Back End</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/node/" class="nav-link router-link-active">
  node
</a></li><li class="dropdown-item"><!----> <a href="/blog/dotnet/" class="nav-link">
  dotnet
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Computer Science" class="dropdown-title"><span class="title">Computer Science</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/operating system/" class="nav-link">
  OS
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Front End" class="dropdown-title"><span class="title">Front End</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/angular/" class="nav-link">
  Angular
</a></li><li class="dropdown-item"><!----> <a href="/blog/react/" class="nav-link">
  React
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/ba11breaker" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/blog/node/" aria-current="page" class="sidebar-link">Start Node.js</a></li><li><a href="/blog/node/koa1.html" class="sidebar-link">Koa in Action(1): Start Application</a></li><li><a href="/blog/node/koa2.html" class="sidebar-link">Koa in Action(2): More Koa</a></li><li><a href="/blog/node/koa3.html" class="sidebar-link">Koa in Action(3): Koa Controller</a></li><li><a href="/blog/node/koa4.html" aria-current="page" class="active sidebar-link">Koa in Action(4): Error in Koa</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/node/koa5.html" class="sidebar-link">Koa in Action(5): MongoDB and Koa</a></li><li><a href="/blog/node/koa6.html" class="sidebar-link">Koa in Action(6): JWT</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="koa-in-action-4-error-in-koa"><a href="#koa-in-action-4-error-in-koa" class="header-anchor">#</a> Koa in Action 4: Error in Koa</h1> <hr> <p>In this article, we will see how to process error in the Koa framework.</p> <p>First, we will have a look at native error process methods in Koa. If request <strong>http://localhost:3000/jdsfds</strong>,
you will get a response which is 'Not Found' and status is '404', that is an error that there is no such kind of methods to
process this URL request.</p> <p>And if you wanna trigger a <strong>412</strong> error, we can add a <code>throw()</code> method in <code>app/controllers/users.js</code>.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">findById</span><span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id <span class="token operator">*</span> <span class="token number">1</span> <span class="token operator">&gt;=</span> db<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ctx<span class="token punctuation">.</span><span class="token function">throw</span><span class="token punctuation">(</span><span class="token number">412</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> db<span class="token punctuation">[</span>ctx<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id <span class="token operator">*</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>And use it in <code>app/routes/users.js</code>.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> Router <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-router'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">{</span> prefix<span class="token operator">:</span> <span class="token string">'/users'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> UsersController <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../controllers/users'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> UsersController<span class="token punctuation">.</span>find<span class="token punctuation">)</span><span class="token punctuation">;</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> UsersController<span class="token punctuation">.</span>create<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Use 412 Error Process</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/:id'</span><span class="token punctuation">,</span> UsersController<span class="token punctuation">.</span>findById<span class="token punctuation">)</span><span class="token punctuation">;</span>
router<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">'/:id'</span><span class="token punctuation">,</span> UsersController<span class="token punctuation">.</span>update<span class="token punctuation">)</span><span class="token punctuation">;</span>
router<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token string">'/:id'</span><span class="token punctuation">,</span> UsersController<span class="token punctuation">.</span>delete<span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> router<span class="token punctuation">;</span>
</code></pre></div><p><code>db</code> is an array contains the list of users, and if you request like
<strong>http://localhost:3000\users\2432534524</strong>, and 2432534524 is obviously larger than
the list, it will retuen 'Precondition Failed' and status is '412'.</p> <p>Then is <strong>500</strong> error, Internal Server Error, which is very common in daily life.
Usually, if there are is an error happen in the backend system and the request from client trigger
the error, it will return <strong>500</strong> error. And you can see the error stack in the console of Server.</p> <p>For example, we add a <code>test()</code> method which is not defined or imported in <strong>UsersController</strong>.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">UsersController</span> <span class="token punctuation">{</span>
    <span class="token function">find</span><span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> db<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Request <strong>http://localhost:3000/users</strong>, you will get response of 'Internal Server Error' and the
status is '500'. You will find the error stack in the console.</p> <div class="language-bash extra-class"><pre class="language-bash"><code>ReferenceError: <span class="token builtin class-name">test</span> is not defined
<span class="token punctuation">..</span>.
</code></pre></div><p>But the native error process in Koa is not enough because we hope all responses can be formed by json
for RESTful API. In this way, we need to write middleware for error processing.</p> <h3 id="write-middleware-for-error"><a href="#write-middleware-for-error" class="header-anchor">#</a> Write Middleware for Error</h3> <hr> <p>It is very simple to write such a middleware, we can write a middleware in front of all middlewares functions in
<code>app/index.js</code> and use try catch structure.</p> <div class="language-js extra-class"><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span>status <span class="token operator">=</span> err<span class="token punctuation">.</span>status <span class="token operator">||</span> err<span class="token punctuation">.</span>statusCode <span class="token operator">||</span> <span class="token number">500</span><span class="token punctuation">;</span>
        ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span>
            message<span class="token operator">:</span> err<span class="token punctuation">.</span>message<span class="token punctuation">,</span>
            status<span class="token operator">:</span> ctx<span class="token punctuation">.</span>status
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">bodyparser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">routing</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'We are lisitening at http://localhost:3000'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Now that if you request <strong>http://localhost:3000\users\2432534524</strong>, it will return
a json with <strong>412</strong> status:</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;message&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Precondition Failed&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;status&quot;</span><span class="token operator">:</span> <span class="token number">412</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="koa-json-error"><a href="#koa-json-error" class="header-anchor">#</a> Koa-json-error</h3> <hr> <p>We have implemented middleware for error processing ourselves and then I recommend a module called
<code>koa-json-error</code> to help us in real world development.</p> <p>First, install <code>koa-json-error</code> using npm.</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">npm</span> i koa-json-error --save
</code></pre></div><p>And then, we import it into <code>app\index.js</code> and use it in the method <code>app.use()</code>.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> error <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-json-error'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>To test it, we request <strong>http://localhost:3000\users\2432534524</strong>, it will return a json with
status and error statck.</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;message&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Precondition Failed&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;PreconditionFailedError&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;stack&quot;</span><span class="token operator">:</span> <span class="token string">&quot;PreconditionFailedError: Precondition Failed\n    at Object.throw (D:\\repository\\koa-repo\\quora-api\\node_modules\\koa\\lib\\context.js:97:11)\n    at findById (D:\\repository\\koa-repo\\quora-api\\app\\controllers\\users.js:12:22)\n    at dispatch (D:\\repository\\koa-repo\\quora-api\\node_modules\\koa-compose\\index.js:42:32)\n    at D:\\repository\\koa-repo\\quora-api\\node_modules\\koa-router\\lib\\router.js:368:16\n    at dispatch (D:\\repository\\koa-repo\\quora-api\\node_modules\\koa-compose\\index.js:42:32)\n    at D:\\repository\\koa-repo\\quora-api\\node_modules\\koa-compose\\index.js:34:12\n    at dispatch (D:\\repository\\koa-repo\\quora-api\\node_modules\\koa-router\\lib\\router.js:373:31)\n    at dispatch (D:\\repository\\koa-repo\\quora-api\\node_modules\\koa-compose\\index.js:42:32)\n    at allowedMethods (D:\\repository\\koa-repo\\quora-api\\node_modules\\koa-router\\lib\\router.js:429:12)\n    at dispatch (D:\\repository\\koa-repo\\quora-api\\node_modules\\koa-compose\\index.js:42:32)&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;status&quot;</span><span class="token operator">:</span> <span class="token number">412</span>
<span class="token punctuation">}</span>
</code></pre></div><p>But it is not safe to show so many error information in prodcution environment, so we neet to de some configuration in <code>app/index.js</code>.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> bodyparser <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-bodyparser'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> error <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-json-error'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> routing <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./routes'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token function-variable function">postFormat</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> <span class="token punctuation">{</span> stack<span class="token punctuation">,</span> <span class="token operator">...</span>rest <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">'production'</span>
        <span class="token operator">?</span> rest <span class="token operator">:</span> <span class="token punctuation">{</span> stack<span class="token punctuation">,</span> <span class="token operator">...</span>rest <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">bodyparser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">routing</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'We are lisitening at http://localhost:3000'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>In windows platform, if you want to run the application in production environment more
conveniently, you can install a module called <code>cross-env</code>. Remember save it in dev dependencies.</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">npm</span> i cross-env --save-dev
</code></pre></div><p>You can use the command <code>cross-env NODE_ENV=production node app</code> to run the application in prodcution
environment. In other OS, you can directly run command <code>NODE_ENV=prodcution node app</code> to run it.</p> <h3 id="koa-parameter"><a href="#koa-parameter" class="header-anchor">#</a> Koa-parameter</h3> <hr> <p>We can install <code>koa-parameter</code> to check the parameter in http request body.</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">npm</span> i koa-parameter --save
</code></pre></div><p>After installation, we need to register it in <code>app/index.js</code>.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> parameter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-parameter'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">parameter</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>If we wanna check whether the body in a http request is what we want, we can
use this middleware in controller functions. For example, we hope the request to
create a user contains <strong>name</strong> and <strong>age</strong> attributes and <strong>name</strong> is compulsory,
we can use <code>ctx.verifyParams()</code>.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">create</span><span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span><span class="token function">verifyParams</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        name<span class="token operator">:</span> <span class="token punctuation">{</span>
            type<span class="token operator">:</span> <span class="token string">'string'</span><span class="token punctuation">,</span>
            required<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        age<span class="token operator">:</span> <span class="token punctuation">{</span>
            ype<span class="token operator">:</span> <span class="token string">'number'</span><span class="token punctuation">,</span>
            required<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    db<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>If request doesn't satisfy the requirements and the system will return <strong>422</strong> status code
and error messages.</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;message&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Validation Failed&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;errors&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token property">&quot;message&quot;</span><span class="token operator">:</span> <span class="token string">&quot;should be a string&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;code&quot;</span><span class="token operator">:</span> <span class="token string">&quot;invalid&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;field&quot;</span><span class="token operator">:</span> <span class="token string">&quot;name&quot;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">&quot;params&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token number">123</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/node/koa3.html" class="prev">
        Koa in Action(3): Koa Controller
      </a></span> <span class="next"><a href="/blog/node/koa5.html">
        Koa in Action(5): MongoDB and Koa
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/blog/assets/js/app.cdb96da4.js" defer></script><script src="/blog/assets/js/2.f437480e.js" defer></script><script src="/blog/assets/js/13.41210d01.js" defer></script>
  </body>
</html>
